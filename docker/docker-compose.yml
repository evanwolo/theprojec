version: '3.8'

services:
  # Interactive kernel simulation
  kernel:
    build:
      context: ..
      dockerfile: Dockerfile
    image: grand-strategy-kernel:latest
    container_name: kernel-sim
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    stdin_open: true
    tty: true
    volumes:
      - ../data:/app/data
    environment:
      - TERM=xterm-256color
    command: /app/KernelSim
    restart: unless-stopped

  # Batch simulation runner
  batch:
    build:
      context: ..
      dockerfile: Dockerfile
    image: grand-strategy-kernel:latest
    container_name: kernel-batch
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    volumes:
      - ../data:/app/data
    environment:
      - POPULATION=50000
      - REGIONS=200
      - TICKS=1000
      - LOG_INTERVAL=10
    command: >
      sh -c 'echo "run ${TICKS:-1000} ${LOG_INTERVAL:-10}" | /app/KernelSim'
    profiles:
      - batch

  # Legacy prototype (200 agents)
  legacy:
    build:
      context: ..
      dockerfile: Dockerfile
    image: grand-strategy-kernel:latest
    container_name: opinion-sim
    stdin_open: true
    tty: true
    volumes:
      - ../data:/app/data
    command: /app/OpinionSim
    profiles:
      - legacy
